version: 2.1

orbs:
  aws-cli: circleci/aws-cli@0.1.13
  aws-ecr: circleci/aws-ecr@6.5.0
  assume-role: airswap/assume-role@0.2.0

jobs:

  apollo:
    docker:
      - image: circleci/node:14
    steps:
      - checkout
      - run:
          name: install apollo
          # CircleCI needs global installs to be sudo
          command: |
            sudo npm install -g apollo
      - run:
          name: push service
          command: |
            apollo service:push --graph=pocket-client-api --localSchemaFile=schema.graphql --key=$APOLLO_KEY --serviceURL=https://explore-topics.readitatler.com/ --serviceName=explore-topics

  test:
    docker:
      - image: python:3.8
        auth:
          username: $DOCKERHUB_USERNAME
          password: $DOCKERHUB_PASSWORD
      - image: localstack/localstack:0.12.1
        auth:
          username: $DOCKERHUB_USERNAME
          password: $DOCKERHUB_PASSWORD
        environment:
          DEBUG: 1
          SERVICES: 'dynamodb'
          DATA_DIR: /tmp/localstack/data
          EXTRA_CORS_ALLOWED_HEADERS: Content-Disposition, Content-Type, x-amz-acl
          EXTRA_CORS_EXPOSE_HEADERS: ETag
          HOSTNAME_EXTERNAL: localstack
          PORT_WEB_UI: 8080
    steps:
      - checkout
      - run:
          name: Build environment and install requirements
          command: |
            pip install pipenv
            pipenv install --dev
      - run:
          name: run setup.sh
          command: export $(egrep -v '^#' .docker/local.env | xargs -0) && ./.circleci/scripts/setup.sh --aws
      - run:
          name: Run tests
          command: |
            mkdir test-reports
            export $(egrep -v '^#' .docker/local.env | xargs -0)
            pipenv run pytest tests/ --junitxml=test-reports/junit.xml
      - store_test_results:
          path: test-reports


  build:
    docker:
      - image: pocket/ops-cli:v0.0.5
        auth:
          username: $DOCKERHUB_USERNAME
          password: $DOCKERHUB_PASSWORD
        environment:
          MAIN_IMAGE_NAME: explore-topics
    steps:
      - checkout
      - run:
          name: Setup common environment variables
          command: |
            echo 'export AWS_ECR_ACCOUNT_PROD_URL="${ACCOUNT_ID_PROD}.dkr.ecr.us-east-1.amazonaws.com"' >> $BASH_ENV
            echo 'export AWS_ECR_ACCOUNT_DEV_URL="${ACCOUNT_ID_DEV}.dkr.ecr.us-east-1.amazonaws.com"' >> $BASH_ENV
      - run:
          command: |
            echo 'export AWS_ECR_ACCOUNT_URL="${AWS_ECR_ACCOUNT_DEV_URL}"' >> $BASH_ENV
# When we have AWS setup start pushing the image.
#      - assume-role/assume-role:
#          account-id: $ACCOUNT_ID_DEV
#      - aws-ecr/build-and-push-image:
      - setup_remote_docker
      - aws-ecr/build-image:
          repo: $MAIN_IMAGE_NAME
          tag: $CIRCLE_SHA1
          dockerfile: ./.docker/images/app/Dockerfile


# Workflow shortcuts
not_main: &not_main
  filters:
    branches:
      ignore:
        - main

only_main: &only_main
  filters:
    branches:
      only:
        - master

workflows:
   all:
     jobs:
       - test:
           <<: *not_main
           context: pocket
       - build:
           context: pocket
